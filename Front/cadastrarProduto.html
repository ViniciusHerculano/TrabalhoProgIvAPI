<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>PROMOS - LEVEL UP</title>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="src/css/style.css">
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=Ds2ibU4TrA1Y4tK3L6J6OqpxMP3J9kC7MF_9_EkTDXyJiCl0DggEwEpqu8mnbSHFJkFvlVYNwKqD6YmyKj5HveSwgRae4MAgGN8wcj-T_8UgDcSUU_maxFEx9-ovXujyV4pa-8I4_pToT_d5wUPCdo6s_YRmJfZQBNBitKh8BgA"
        charset="UTF-8"></script>
</head>


<!-- -->

<body class="">
    <form class="precisa-validar" id="formulario-principal" novalidate>
        <div class="row">
            <div class="input-field col s5">
                <input id="campo-nome" type="text" name="nome" class="validate" required pattern="[A-Za-zÀ-ú\s]+$" required minlength="2" maxlength="20">
                <label for="nome" data-error="Preencha o campo Nome" class="active">Nome</label>

            </div>
        </div>
        <div class="row">
            <div class="input-field col s5">
                <input id="campo-descricao" type="text" required>
                <label for="input_text">descricao</label>
            </div>
        </div>
        <div class="row">
            <div class="input-field col s5">
                <input id="campo-plataforma" type="text" required>
                <label for="input_text">Plataforma</label>
            </div>
        </div>
        <div class="row">
            <div class="input-field col s5">
                <input id="campo-categoria" type="text" required>
                <label for="input_text">Categoria</label>
            </div>
        </div>
        <div class="row">
            <div class="input-field col s5">
                <input id="campo-preco" type="text" required>
                <label for="input_text">Preço</label>
            </div>
        </div>
        <div>
            <a id="btn-enviar" class="waves-effect waves-light btn-large">Cadastrar</a>
            <a id="btn-consultar" class="waves-effect waves-light btn-large">Consultar</a>
            <a id="btn-validar" type="submit" class="waves-effect waves-light btn-large">Validar</a>
        </div>
        <div>
    </form>
    <hr>

    <table id="grade-postagens" class="striped">
        <thead>
            <tr>
                <th>Nome</th>
                <th>Descrição</th>
                <th>Plataforma</th>
                <th>Categoria</th>
                <th>Preço</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>





    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script src="src/js/jquery-3.5.1.min.js"></script>

    <script>
        (function() {
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('precisa-validar');

                var validacao = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() == false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });

            }, false);
        })();


        var endpoint = 'https://localhost:5001'

        var fApi = {
                requisicaoAdicionar: function(endpoint, valor) {
                    try {

                        $.ajax({
                            url: endpoint + "/v1/games",
                            data: valor,
                            type: 'POST',
                            contentType: 'application/json',
                            dataType: 'json',
                            success: function(result) {
                                let mensagem = `Registro efetuado: ${result.nome} com o conteúdo ${result.stringify}`;
                                alert(mensagem);

                            }
                        });
                    } catch (e) {
                        alert('Erro ao enviar requisição ajax. Detalhes:' + e.message);
                    }
                },
                requisicaoConsultar: function(endpoint) {

                    try {
                        $.ajax({
                            url: endpoint + "/v1/games",
                            data: null,
                            type: 'GET',
                            contentType: 'application/json',
                            dataType: 'json',
                            success: function(result) {
                                var lista = '';
                                $(result).each(function(index, value) {
                                    var retNome = value.nome;
                                    var retDescricao = value.descricao;
                                    var retPlataforma = value.plataforma;
                                    var retCategoria = value.categoria;
                                    var retPreco = value.preco;

                                    lista += `<tr><td>${retNome}</td><td>${retDescricao}</td><td>${retPlataforma}</td><td>${retCategoria}</td><td>${retPreco}<td></tr>`;
                                });
                                $('#grade-postagens tbody').empty().append(lista);
                            }

                        });
                    } catch (e) {
                        alert('Erro ao enviar requisição ajax. Detalhes:' + e.message);
                    }
                }
            } //Fim-api


        //Checa a validação e altera o estado dos botoões
        $('#btn-validar').click(function() {
            if (document.getElementsByClassName('precisa-validar')[0].checkValidity()) {
                $('#btn-validar').attr('disabled', true);

                $('#btn-enviar').show();
            } else {
                $('#btn-validar').attr('disabled', true);

                $('#btn-enviar').hide();
            }
        });



        $('#btn-enviar').click(function() {
            if (document.getElementsByClassName('precisa-validar')[0].checkValidity()) {
                fApi.requisicaoAdicionar(endpoint, JSON.stringify({
                    nome: $('#campo-nome').val(),
                    descricao: $('#campo-descricao').val(),
                    plataforma: $('#campo-plataforma').val(),
                    categoria: $('#campo-categoria').val(),
                    preco: $('#campo-preco').val()
                }));
            } else
                alert('Formulário inválido')
        }); //Fim Ação do botão enviar

        $(document).ready(function() {
            $("#btn-enviar").hide();
            fApi.requisicaoConsultar(endpoint)
        }); //Fim ação do botão consultar
    </script>
</body>

</html>